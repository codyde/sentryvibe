{"version":3,"sources":["../src/auth.ts","../src/index.ts"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["/**\n * Authentication helpers for OpenCode Service\n * \n * Validates runner keys and shared secrets for API access.\n * Integrates with the existing SentryVibe auth system.\n */\n\nimport { createHash } from 'crypto';\nimport { db } from '@sentryvibe/agent-core';\nimport { runnerKeys } from '@sentryvibe/agent-core/lib/db/schema';\nimport { eq, and, isNull } from 'drizzle-orm';\n\n/**\n * Check if running in local mode\n */\nexport function isLocalMode(): boolean {\n  return process.env.SENTRYVIBE_LOCAL_MODE === 'true';\n}\n\n/**\n * Hash a runner key for lookup\n */\nexport function hashRunnerKey(key: string): string {\n  return createHash('sha256').update(key).digest('hex');\n}\n\n/**\n * Result of runner key authentication\n */\nexport interface AuthResult {\n  authenticated: boolean;\n  userId?: string;\n  keyId?: string;\n  error?: string;\n}\n\n/**\n * Authenticate a runner key against the database\n */\nexport async function authenticateRunnerKey(key: string): Promise<AuthResult> {\n  // Local mode - always allow\n  if (isLocalMode()) {\n    return {\n      authenticated: true,\n      userId: '00000000-0000-0000-0000-000000000000',\n      keyId: 'local',\n    };\n  }\n\n  if (!key || !key.startsWith('sv_')) {\n    return {\n      authenticated: false,\n      error: 'Invalid runner key format',\n    };\n  }\n\n  try {\n    const keyHash = hashRunnerKey(key);\n    \n    // Query the runner_keys table using drizzle ORM\n    const result = await db\n      .select({\n        id: runnerKeys.id,\n        userId: runnerKeys.userId,\n      })\n      .from(runnerKeys)\n      .where(\n        and(\n          eq(runnerKeys.keyHash, keyHash),\n          isNull(runnerKeys.revokedAt)\n        )\n      )\n      .limit(1);\n\n    if (result.length > 0) {\n      const row = result[0];\n      \n      // Update last used timestamp (fire and forget)\n      db.update(runnerKeys)\n        .set({ lastUsedAt: new Date() })\n        .where(eq(runnerKeys.id, row.id))\n        .catch(() => {\n          // Ignore update errors\n        });\n\n      return {\n        authenticated: true,\n        userId: row.userId,\n        keyId: row.id,\n      };\n    }\n\n    return {\n      authenticated: false,\n      error: 'Invalid or revoked runner key',\n    };\n  } catch (error) {\n    console.error('[opencode-service] Error validating runner key:', error);\n    return {\n      authenticated: false,\n      error: 'Failed to validate runner key',\n    };\n  }\n}\n\n/**\n * Extract runner key from request headers\n */\nexport function extractRunnerKey(headers: Record<string, string | string[] | undefined>): string | null {\n  const authHeader = headers['authorization'];\n  if (!authHeader) return null;\n\n  const auth = Array.isArray(authHeader) ? authHeader[0] : authHeader;\n  if (!auth) return null;\n\n  // Support both \"Bearer sv_xxx\" and just \"sv_xxx\"\n  if (auth.startsWith('Bearer sv_')) {\n    return auth.substring(7);\n  }\n\n  if (auth.startsWith('sv_')) {\n    return auth;\n  }\n\n  return null;\n}\n\n/**\n * Extract token (any format) from request headers\n */\nexport function extractToken(headers: Record<string, string | string[] | undefined>): string | null {\n  const authHeader = headers['authorization'];\n  if (!authHeader) return null;\n\n  const auth = Array.isArray(authHeader) ? authHeader[0] : authHeader;\n  if (!auth) return null;\n\n  // Remove Bearer prefix if present\n  if (auth.startsWith('Bearer ')) {\n    return auth.substring(7);\n  }\n\n  return auth;\n}\n\n/**\n * Authenticate a request\n * \n * Accepts:\n * - Runner key (sv_xxx) - validated against database\n * - Shared secret - validated against RUNNER_SHARED_SECRET env var\n * - Local mode - always allows\n */\nexport async function authenticateRequest(\n  headers: Record<string, string | string[] | undefined>\n): Promise<AuthResult> {\n  // Local mode - always allow\n  if (isLocalMode()) {\n    return {\n      authenticated: true,\n      userId: '00000000-0000-0000-0000-000000000000',\n    };\n  }\n\n  // Try runner key first\n  const runnerKey = extractRunnerKey(headers);\n  if (runnerKey) {\n    return authenticateRunnerKey(runnerKey);\n  }\n\n  // Fall back to shared secret\n  const token = extractToken(headers);\n  const sharedSecret = process.env.RUNNER_SHARED_SECRET;\n\n  if (sharedSecret && token === sharedSecret) {\n    return {\n      authenticated: true,\n    };\n  }\n\n  return {\n    authenticated: false,\n    error: 'No valid authentication provided',\n  };\n}\n","#!/usr/bin/env node\n/**\n * OpenCode Service\n * \n * A wrapper service that:\n * 1. Starts an OpenCode server internally\n * 2. Validates runner key / shared secret authentication\n * 3. Proxies authenticated requests to OpenCode\n * \n * This provides a unified AI service for both the frontend and runner.\n */\n\nimport express, { Request, Response, NextFunction } from 'express';\nimport { createProxyMiddleware, fixRequestBody } from 'http-proxy-middleware';\nimport { createOpencode } from '@opencode-ai/sdk';\nimport * as Sentry from '@sentry/node';\nimport { authenticateRequest, isLocalMode } from './auth.js';\n\n// Configuration\nconst PORT = parseInt(process.env.OPENCODE_SERVICE_PORT || '4096', 10);\nconst INTERNAL_PORT = parseInt(process.env.OPENCODE_INTERNAL_PORT || '4097', 10);\nconst HOST = process.env.OPENCODE_SERVICE_HOST || '0.0.0.0';\n\n// Initialize Sentry if configured\nif (process.env.SENTRY_DSN) {\n  Sentry.init({\n    dsn: process.env.SENTRY_DSN,\n    environment: process.env.NODE_ENV || 'development',\n    tracesSampleRate: 0.1,\n  });\n}\n\nasync function main() {\n  console.log('[opencode-service] Starting OpenCode service...');\n  console.log(`[opencode-service] Local mode: ${isLocalMode()}`);\n  \n  // Start OpenCode server internally\n  console.log(`[opencode-service] Starting internal OpenCode server on port ${INTERNAL_PORT}...`);\n  \n  let opencodeInstance: Awaited<ReturnType<typeof createOpencode>> | null = null;\n  \n  try {\n    opencodeInstance = await createOpencode({\n      hostname: '127.0.0.1',\n      port: INTERNAL_PORT,\n      timeout: 30000, // 30 second timeout for server start\n      config: {\n        // Default model - can be overridden per request\n        model: process.env.OPENCODE_DEFAULT_MODEL || 'anthropic/claude-sonnet-4-5',\n      },\n    });\n    \n    console.log(`[opencode-service] Internal OpenCode server started at ${opencodeInstance.server.url}`);\n  } catch (error) {\n    console.error('[opencode-service] Failed to start internal OpenCode server:', error);\n    console.error('[opencode-service] Make sure opencode-ai is installed globally or the opencode CLI is available');\n    process.exit(1);\n  }\n\n  // Create Express app\n  const app = express();\n\n  // Health check endpoint (no auth required)\n  app.get('/health', async (_req: Request, res: Response) => {\n    try {\n      // Use type assertion since SDK types may vary\n      const client = opencodeInstance?.client as any;\n      const health = await client?.global?.health?.();\n      res.json({\n        status: 'healthy',\n        opencode: health?.data,\n        service: {\n          port: PORT,\n          internalPort: INTERNAL_PORT,\n          localMode: isLocalMode(),\n        },\n      });\n    } catch (error) {\n      res.status(503).json({\n        status: 'unhealthy',\n        error: error instanceof Error ? error.message : String(error),\n      });\n    }\n  });\n\n  // Auth middleware\n  app.use(async (req: Request, res: Response, next: NextFunction) => {\n    // Skip auth for health check\n    if (req.path === '/health') {\n      return next();\n    }\n\n    const authResult = await authenticateRequest(req.headers as Record<string, string | string[] | undefined>);\n\n    if (!authResult.authenticated) {\n      console.log(`[opencode-service] Auth failed: ${authResult.error}`);\n      return res.status(401).json({\n        error: 'Unauthorized',\n        message: authResult.error,\n      });\n    }\n\n    // Attach auth info to request for potential downstream use\n    (req as any).auth = {\n      userId: authResult.userId,\n      keyId: authResult.keyId,\n    };\n\n    next();\n  });\n\n  // Log requests\n  app.use((req: Request, _res: Response, next: NextFunction) => {\n    const auth = (req as any).auth;\n    console.log(`[opencode-service] ${req.method} ${req.path} [user: ${auth?.userId || 'unknown'}]`);\n    next();\n  });\n\n  // Proxy all other requests to OpenCode\n  const proxy = createProxyMiddleware({\n    target: `http://127.0.0.1:${INTERNAL_PORT}`,\n    changeOrigin: true,\n    ws: true, // Enable WebSocket proxying for SSE\n    on: {\n      proxyReq: fixRequestBody,\n      error: (err, _req, res) => {\n        console.error('[opencode-service] Proxy error:', err);\n        if (res && 'writeHead' in res) {\n          (res as Response).status(502).json({\n            error: 'Proxy error',\n            message: err.message,\n          });\n        }\n      },\n    },\n  });\n\n  app.use('/', proxy);\n\n  // Start the service\n  const server = app.listen(PORT, HOST, () => {\n    console.log(`[opencode-service] Service listening on http://${HOST}:${PORT}`);\n    console.log('[opencode-service] Ready to accept requests');\n  });\n\n  // Graceful shutdown\n  const shutdown = async (signal: string) => {\n    console.log(`[opencode-service] Received ${signal}, shutting down...`);\n    \n    server.close(() => {\n      console.log('[opencode-service] HTTP server closed');\n    });\n\n    if (opencodeInstance) {\n      try {\n        opencodeInstance.server.close();\n        console.log('[opencode-service] Internal OpenCode server closed');\n      } catch (error) {\n        console.error('[opencode-service] Error closing OpenCode server:', error);\n      }\n    }\n\n    process.exit(0);\n  };\n\n  process.on('SIGTERM', () => shutdown('SIGTERM'));\n  process.on('SIGINT', () => shutdown('SIGINT'));\n}\n\n// Run\nmain().catch((error) => {\n  console.error('[opencode-service] Fatal error:', error);\n  Sentry.captureException(error);\n  process.exit(1);\n});\n"]}